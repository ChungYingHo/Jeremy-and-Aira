---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';

// 1. 輔助函式：從檔名解析日期
const parseDateFromSlug = (slug: string): Date | null => {
  const match = slug.match(/^(\d{4})(\d{2})(\d{2})-/);
  if (match) {
    return new Date(`${match[1]}-${match[2]}-${match[3]}`);
  }
  return null;
};

// 2. 輔助函式：產生文章摘要
const getPostExcerpt = (post: any) => {
  if (post.data.description) return post.data.description;
  const body = post.body || '';
  return body
    .replace(/^#+\s+(.*)/gm, '$1')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[(.*?)\]\(.*?\)/g, '$1')
    .replace(/`{3}[\s\S]*?`{3}/g, '')
    .replace(/`(.+?)`/g, '$1')
    .replace(/(\*\*|__)(.*?)\1/g, '$2')
    .replace(/(\*|_)(.*?)\1/g, '$2')
    .replace(/\n/g, ' ')
    .trim()
    .substring(0, 140) + '...';
};

// 3. 抓取 blog 集合並排序
const posts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

const sortedPosts = posts.sort((a, b) => {
  const dateA = a.data.date ? new Date(a.data.date).valueOf() : (parseDateFromSlug(a.slug)?.valueOf() || 0);
  const dateB = b.data.date ? new Date(b.data.date).valueOf() : (parseDateFromSlug(b.slug)?.valueOf() || 0);
  return dateB - dateA;
});

// 4. 日期格式化
const getDateParts = (date: Date | string | undefined, slug: string) => {
  let validDate = date ? new Date(date) : parseDateFromSlug(slug);
  if (!validDate || isNaN(validDate.getTime())) return { year: '', dateStr: '' };
  
  return {
    year: validDate.getFullYear().toString(),
    dateStr: validDate.toLocaleDateString('en-US', { month: 'short', day: '2-digit' }) 
  };
}
---

<Layout title="Blog">
  <div class="fixed inset-0 z-[-1] w-full h-full pointer-events-none bg-[#0a0a0c]">
    <div class="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"></div>
    <div class="absolute top-0 left-0 w-[800px] h-[600px] bg-pink-500/10 blur-[150px] rounded-full opacity-50"></div>
    <div class="absolute bottom-0 right-0 w-[600px] h-[600px] bg-indigo-500/10 blur-[150px] rounded-full opacity-50"></div>
  </div>

  <div class="max-w-4xl mx-auto px-5 md:px-6 py-10 md:py-20 animate-fade-in-up relative">
    
    <header class="mb-10 md:mb-20 pl-4 border-l-2 md:border-l-4 border-pink-500">
      <h1 class="text-5xl md:text-8xl font-black tracking-tighter text-white mb-2 leading-none">
        BLOG
      </h1>
      <p class="text-slate-400 font-mono text-xs md:text-base tracking-[0.2em] uppercase flex items-center gap-2 md:gap-3">
        <span class="w-4 md:w-8 h-[1px] bg-slate-600"></span>
        Fragments & Musings
      </p>
    </header>

    <div class="relative border-l border-white/10 ml-2 md:ml-0 space-y-8 md:space-y-12 pb-12">
      
      {sortedPosts.map((post, index) => {
        const { year, dateStr } = getDateParts(post.data.date, post.slug);
        
        return (
          <div class="relative pl-6 md:pl-12 group">
            
            <div class="absolute -left-[5px] top-2 w-[9px] h-[9px] rounded-full bg-slate-800 border border-slate-600 group-hover:bg-pink-500 group-hover:border-pink-400 group-hover:shadow-[0_0_10px_rgba(244,114,182,0.8)] transition-all duration-300 z-10"></div>
            
            <a href={`/blog/${post.slug}`} class="block group/card">
              <article class="relative p-5 md:p-6 -ml-3 md:-ml-4 rounded-xl transition-all duration-500 hover:bg-white/[0.03] border border-transparent hover:border-white/5">
                
                <div class="flex items-center gap-3 mb-3">
                  <span class="font-mono text-xs font-bold text-pink-400 bg-pink-500/10 px-2 py-1 rounded border border-pink-500/20">
                    {year}
                  </span>
                  <span class="font-mono text-sm text-slate-500 group-hover/card:text-slate-300 transition-colors">
                    {dateStr}
                  </span>
                </div>

                <h2 class="text-xl md:text-3xl font-bold text-slate-200 mb-3 md:mb-4 transition-all duration-300 group-hover/card:text-transparent group-hover/card:bg-clip-text group-hover/card:bg-gradient-to-r group-hover/card:from-white group-hover/card:to-slate-400 leading-tight">
                  {post.data.title}
                </h2>

                <p class="text-slate-400 text-sm md:text-base leading-relaxed line-clamp-2 md:line-clamp-3 mb-4 md:mb-6 max-w-2xl group-hover/card:text-slate-300 transition-colors">
                  {getPostExcerpt(post)}
                </p>

                <div class="flex flex-wrap items-center justify-between gap-4 border-t border-white/5 pt-4 mt-auto">
                  
                  {/* Tags */}
                  <div class="flex flex-wrap gap-2">
                    {post.data.tags && post.data.tags.slice(0, 3).map(tag => (
                      <span class="text-[10px] font-mono text-slate-500 before:content-['#'] group-hover/card:text-indigo-300 transition-colors">
                        {tag}
                      </span>
                    ))}
                  </div>

                  <div class="text-[10px] md:text-xs font-bold text-slate-600 uppercase tracking-widest flex items-center gap-2 group-hover/card:text-white transition-colors">
                    Read
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300 group-hover/card:translate-x-1"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                  </div>
                </div>

              </article>
            </a>
          </div>
        );
      })}

      <div class="absolute -left-[3px] bottom-0 w-[5px] h-[5px] rounded-full bg-white/20"></div>
    </div>

  </div>
</Layout>

<style>
  @keyframes fade-in-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in-up { animation: fade-in-up 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
</style>