---
import Layout from '@/layouts/Layout.astro';
---

<Layout title="Welcome">
  <main 
    id="canvas-area"
    class="fixed inset-0 z-0 w-full h-full bg-[#121011] text-white overflow-hidden font-sans selection:bg-pink-500 selection:text-white"
  >
    
    <div id="splatter-container" class="absolute inset-0 pointer-events-none z-0"></div>

    <div class="relative z-10 w-full h-full flex flex-col items-center justify-center pointer-events-none">
      
      <div 
        id="greeting-container" 
        class="text-center space-y-6 opacity-0 translate-y-4 transition-all duration-1000 ease-out"
      >
        <h2 
          id="greeting-sub" 
          class="text-xl md:text-2xl font-bold text-pink-100 tracking-[0.3em] uppercase drop-shadow-md"
        >
          </h2>

        <h1 
          id="greeting-main" 
          class="text-6xl md:text-8xl xl:text-[10rem] font-black tracking-tighter text-white drop-shadow-[0_4px_8px_rgba(0,0,0,1)]"
        >
          </h1>

        <div class="pt-6 flex flex-col items-center gap-4">
          <p class="text-2xl md:text-3xl font-bold tracking-wider">
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-pink-300 via-purple-300 to-indigo-300 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]">
              Jeremy &times; Aira
            </span>
          </p>
          
          <div class="flex items-center gap-3 text-xs md:text-sm font-mono text-slate-300 tracking-widest uppercase bg-[#1f1d1e]/90 px-6 py-2 rounded-full border border-white/10 shadow-[0_4px_12px_rgba(0,0,0,0.5)]">
            <span>Front-End Developer</span>
            <span class="text-pink-400 font-bold">|</span>
            <span>Game Designer</span>
          </div>
        </div>

      </div>

      <div 
        id="action-btn"
        class="mt-16 pointer-events-auto opacity-0 translate-y-4 transition-all duration-1000 delay-300 ease-out"
      >
        <a 
          href="/about" 
          class="
            group relative inline-flex items-center gap-3 px-10 py-4 
            bg-white text-black rounded-full 
            transition-all duration-300
            hover:scale-105 hover:bg-pink-50 hover:shadow-[0_0_25px_rgba(255,192,203,0.4)]
            animate-bounce-slow
          "
        >
          <span class="text-xs md:text-sm font-bold tracking-widest">ENTER WORLD</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform group-hover:translate-x-1">
            <path d="M5 12h14"></path>
            <path d="m12 5 7 7-7 7"></path>
          </svg>
        </a>
      </div>

    </div>

    <div class="absolute bottom-10 w-full text-center pointer-events-none opacity-30">
      <p class="text-[10px] font-mono tracking-[0.5em] text-slate-500">CLICK TO PAINT</p>
    </div>

  </main>
</Layout>

<script>
// === 1. Greeting ===
const greetingContainer = document.getElementById('greeting-container')
const greetingMain = document.getElementById('greeting-main')
const greetingSub = document.getElementById('greeting-sub')
const actionBtn = document.getElementById('action-btn')

const initPage = () => {
  const hour = new Date().getHours()
  let mainText = 'Welcome'
  let subText = 'Hello'

  if (hour >= 5 && hour < 12) {
    subText = 'Good Morning'
    mainText = 'Start Creating'
  } else if (hour >= 12 && hour < 18) {
    subText = 'Good Afternoon'
    mainText = 'Keep Inspiring'
  } else {
    subText = 'Good Evening'
    mainText = 'Dream Big'
  }

  if(greetingMain) greetingMain.innerText = mainText
  if(greetingSub) greetingSub.innerText = subText

  requestAnimationFrame(() => {
    greetingContainer?.classList.remove('opacity-0', 'translate-y-4')
    actionBtn?.classList.remove('opacity-0', 'translate-y-4')
  })
}

// === 2. Splatter Logic ===
const container = document.getElementById('splatter-container')
const canvasArea = document.getElementById('canvas-area')
// 定義手機斷點 (小於 640px 視為手機，避開平板)
const PHONE_BREAKPOINT = 640
const MAX_BLOBS = window.innerWidth < PHONE_BREAKPOINT ? 10 : 20 // 手機總上限也稍微調低

const COLORS = [
  '#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', 
  '#9BF6FF', '#A0C4FF', '#BDB2FF', '#FFC6FF', 
]

const random = (min: number, max: number) => Math.random() * (max - min) + min

const createSplatter = (x: number, y: number, isInitial = false) => {
  if (!container) return

  const isPhone = window.innerWidth < PHONE_BREAKPOINT
  const color = COLORS[Math.floor(Math.random() * COLORS.length)]
  
  let size
  if (isPhone) {
    // 手機版：大幅縮小尺寸以避免擁擠
    // 初始載入稍微大一點，普通點擊或閒置生成則很小
    size = isInitial ? random(80, 160) : random(40, 90)
  } else {
    // 電腦/平板版維持原樣
    size = isInitial ? random(150, 350) : random(80, 220)
  }
  
  // Group
  const group = document.createElement('div')
  group.style.position = 'absolute'
  group.style.left = `${x}px`
  group.style.top = `${y}px`
  group.style.pointerEvents = 'none'
  group.style.zIndex = '0'
  group.style.opacity = '1'
  
  // Main Blob
  const mainBlob = document.createElement('div')
  const r1 = random(35, 65)
  const r2 = random(35, 65)
  const r3 = random(35, 65)
  const r4 = random(35, 65)
  
  mainBlob.style.width = `${size}px`
  mainBlob.style.height = `${size}px`
  mainBlob.style.backgroundColor = color
  mainBlob.style.borderRadius = `${r1}% ${100-r1}% ${r3}% ${100-r3}% / ${r2}% ${r4}% ${100-r4}% ${100-r2}%`
  mainBlob.style.transform = `translate(-50%, -50%) rotate(${random(0, 360)}deg) scale(0)`
  mainBlob.style.opacity = '0.85' 
  mainBlob.style.mixBlendMode = 'normal' 
  mainBlob.style.boxShadow = `0 4px 20px -5px ${color}` 
  mainBlob.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)'

  group.appendChild(mainBlob)

  // Droplets (手機版減少飛濺的數量和距離)
  const dropletsCount = isPhone ? Math.floor(random(2, 5)) : Math.floor(random(4, 9))
  
  for (let i = 0; i < dropletsCount; i++) {
    const drop = document.createElement('div')
    // 手機版飛濺液滴也按比例縮小
    const dropSize = random(size * 0.08, size * 0.18)
    const distance = isPhone 
      ? random(size * 0.5, size * 0.7) // 手機版飛濺距離縮短
      : random(size * 0.55, size * 0.9)
    
    const angle = random(0, Math.PI * 2)
    
    const dx = Math.cos(angle) * distance
    const dy = Math.sin(angle) * distance

    drop.style.position = 'absolute'
    drop.style.width = `${dropSize}px`
    drop.style.height = `${dropSize}px`
    drop.style.backgroundColor = color
    drop.style.borderRadius = '50%'
    drop.style.left = '0'
    drop.style.top = '0'
    drop.style.transform = 'translate(-50%, -50%) scale(0)'
    drop.style.opacity = '0.9'
    drop.style.mixBlendMode = 'normal'
    drop.style.boxShadow = `0 2px 10px -2px ${color}`
    drop.style.transition = 'transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
    
    drop.dataset.tx = dx.toString()
    drop.dataset.ty = dy.toString()

    group.appendChild(drop)
  }

  container.appendChild(group)

  requestAnimationFrame(() => {
    mainBlob.style.transform = `translate(-50%, -50%) rotate(${random(0, 360)}deg) scale(1)`
    Array.from(group.children).forEach((child: any, index) => {
      if (index === 0) return
      const tx = child.dataset.tx
      const ty = child.dataset.ty
      child.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(1)`
    })
  })

  // Lifecycle
  setTimeout(() => {
    group.dataset.dying = 'true' 
    group.style.transition = 'opacity 1s ease-out'
    group.style.opacity = '0'
    setTimeout(() => {
      if (container.contains(group)) {
        container.removeChild(group)
      }
    }, 1000)
  }, 5000)

  // Hard Limit (移除最舊的)
  if (container.children.length > MAX_BLOBS) {
    const oldest = container.firstChild
    if (oldest) container.removeChild(oldest)
  }
}

// === 3. Idle Loop ===
let lastInteractionTime = Date.now()

const resetTimer = () => {
  lastInteractionTime = Date.now()
}

const startIdleLoop = () => {
  setInterval(() => {
    const now = Date.now()
    const isPhone = window.innerWidth < PHONE_BREAKPOINT
    
    // 設定閒置生成上限：手機 3 個，其他設備 5 個
    const IDLE_LIMIT = isPhone ? 3 : 5

    let activeCount = 0
    if (container) {
      for (let i = 0; i < container.children.length; i++) {
        if (!container.children[i].hasAttribute('data-dying')) {
          activeCount++
        }
      }
    }

    // 只有在活躍數量低於限制時才自動生成
    if (now - lastInteractionTime > 2000 && activeCount < IDLE_LIMIT) {
      // 確保生成位置稍微向內縮，避免手機版切邊
      const margin = isPhone ? 0.2 : 0.1
      const x = random(window.innerWidth * margin, window.innerWidth * (1 - margin))
      const y = random(window.innerHeight * margin, window.innerHeight * (1 - margin))
      createSplatter(x, y)
    }
  }, 1000)
}

// === 4. Init ===
window.addEventListener('DOMContentLoaded', () => {
  initPage()
  
  // Progressive Entrance (初始動畫)
  // 這裡不需要改，因為 createSplatter 內部已經判斷尺寸了
  setTimeout(() => createSplatter(window.innerWidth * 0.25, window.innerHeight * 0.35, true), 500)
  setTimeout(() => createSplatter(window.innerWidth * 0.75, window.innerHeight * 0.65, true), 1200)
  setTimeout(() => createSplatter(window.innerWidth * 0.5, window.innerHeight * 0.5, true), 2000)
  
  startIdleLoop()
})

if (canvasArea) {
  canvasArea.addEventListener('mousedown', (e) => {
    resetTimer()
    if ((e.target as HTMLElement).closest('a')) return
    createSplatter(e.clientX, e.clientY)
  })
    
  canvasArea.addEventListener('mousemove', resetTimer)
  canvasArea.addEventListener('touchstart', resetTimer)
}

</script>

<style>
  @keyframes bounce-slow {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
</style>