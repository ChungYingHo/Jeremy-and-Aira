<div id="cursor-dot" class="cursor-dot"></div>
<div id="cursor-ring" class="cursor-ring"></div>

<script>
const initCursor = () => {
  // 裝置檢測
  if (window.matchMedia('(pointer: coarse)').matches) return

  const dot = document.getElementById('cursor-dot')
  const ring = document.getElementById('cursor-ring')
  const body = document.body

  if (!dot || !ring) return

  let mouseX = 0
  let mouseY = 0
  let ringX = 0
  let ringY = 0
  let isCursorActive = false 
  let isHoveringText = false 

  document.addEventListener('mousemove', (e) => {
    mouseX = e.clientX
    mouseY = e.clientY

    // === 無縫喚醒邏輯 ===
    if (!isCursorActive) {
      isCursorActive = true
      
      // 瞬間同步座標，避免飛入
      ringX = mouseX
      ringY = mouseY
      
      dot.style.transform = `translate(${mouseX}px, ${mouseY}px)`
      ring.style.transform = `translate(${mouseX}px, ${mouseY}px)`
      
      requestAnimationFrame(() => {
        body.classList.add('custom-cursor-active')
      })
    }

    // Dot 無延遲跟隨
    dot.style.transform = `translate(${mouseX}px, ${mouseY}px)`
  })

  // 點擊與選取偵測
  document.addEventListener('mousedown', () => {
    ring.classList.add('clicking')
    // 只有在文字上按住滑鼠時，才進入「選取模式」(隱藏圓圈)
    if (isHoveringText) {
      ring.classList.add('selecting')
    }
  })

  document.addEventListener('mouseup', () => {
    ring.classList.remove('clicking', 'selecting')
  })

  // 狀態偵測
  const updateCursorState = (e: MouseEvent) => {
    if (!isCursorActive) return 

    const target = e.target as HTMLElement
    
    const clickable = target.closest('a, button, [role="button"], input[type="submit"], input[type="button"], .hover-trigger')
    const textable = target.closest('p, h1, h2, h3, h4, h5, h6, span, code, pre, blockquote, input[type="text"], textarea, label, li, td, th')

    // 更新全域狀態
    isHoveringText = !!textable

    if (clickable) {
      ring.classList.add('hovering')
      ring.classList.remove('text-mode')
      dot.classList.add('hovering')
    } else if (textable) {
      ring.classList.add('text-mode')
      ring.classList.remove('hovering')
      dot.classList.add('text-mode')
    } else {
      ring.classList.remove('hovering', 'text-mode')
      dot.classList.remove('hovering', 'text-mode')
    }
  }

  document.addEventListener('mouseover', updateCursorState)

  // 動畫迴圈 (Lerp)
  const render = () => {
    if (isCursorActive) {
      // 圓圈平滑跟隨
      ringX += (mouseX - ringX) * 0.15
      ringY += (mouseY - ringY) * 0.15
      ring.style.transform = `translate(${ringX}px, ${ringY}px)`
    }
    requestAnimationFrame(render)
  }

  requestAnimationFrame(render)
}

document.addEventListener('astro:page-load', initCursor)
document.addEventListener('DOMContentLoaded', initCursor)
</script>

<style>
  /* === 基礎層級 === */
  .cursor-dot,
  .cursor-ring {
    position: fixed;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 100000;
  }

  /* === 初始狀態 (隱藏) === */
  .cursor-ring {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-left: -16px;
    margin-top: -16px;
    
    /* 空心圓 */
    border: 1px solid rgba(244, 114, 182, 0.4);
    background: radial-gradient(circle, rgba(244, 114, 182, 0.1) 0%, transparent 70%);
    box-shadow: 0 0 10px rgba(244, 114, 182, 0.2);
    
    mix-blend-mode: screen;
    
    /* 初始縮小且透明，等待喚醒 */
    opacity: 0;
    transform: scale(0.5); 
    
    will-change: transform, width, height, opacity;
    transition: width 0.3s, height 0.3s, background 0.3s, border 0.3s, opacity 0.3s;
  }

  .cursor-dot {
    width: 8px;
    height: 8px;
    background-color: white;
    border-radius: 50%;
    margin-left: -4px; 
    margin-top: -4px;
    mix-blend-mode: exclusion;
    opacity: 0;
    transition: opacity 0.3s;
  }

  /* === 啟動狀態 (Active) === */
  @media (pointer: fine) {
    
    /* 一般狀態：隱藏系統游標 */
    :global(body.custom-cursor-active) {
      cursor: none;
    }

    /* 顯示光圈 (喚醒動畫) */
    :global(body.custom-cursor-active) .cursor-ring {
      opacity: 1;
      animation: cursor-spawn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    :global(body.custom-cursor-active) .cursor-dot {
      opacity: 1;
    }

    /* 連結與按鈕：隱藏系統游標 */
    :global(body.custom-cursor-active) :global(a), 
    :global(body.custom-cursor-active) :global(button) {
      cursor: none !important;
    }
    
    /* 在文字上：恢復系統 I-Beam 游標，方便精準選取，但同時保留背景的光圈 */
    :global(body.custom-cursor-active) :global(p),
    :global(body.custom-cursor-active) :global(h1),
    :global(body.custom-cursor-active) :global(h2),
    :global(body.custom-cursor-active) :global(h3),
    :global(body.custom-cursor-active) :global(h4),
    :global(body.custom-cursor-active) :global(h5),
    :global(body.custom-cursor-active) :global(h6),
    :global(body.custom-cursor-active) :global(span),
    :global(body.custom-cursor-active) :global(code),
    :global(body.custom-cursor-active) :global(pre),
    :global(body.custom-cursor-active) :global(blockquote),
    :global(body.custom-cursor-active) :global(li),
    :global(body.custom-cursor-active) :global(td),
    :global(body.custom-cursor-active) :global(th),
    :global(body.custom-cursor-active) :global(input[type="text"]), 
    :global(body.custom-cursor-active) :global(textarea) {
      cursor: text !important;
    }
  }

  @keyframes cursor-spawn {
    0% { opacity: 0; width: 0; height: 0; }
    100% { opacity: 1; width: 32px; height: 32px; }
  }

  /* === 互動模式 (Hover) === */
  /* 變大圓圈，強調可點擊 */
  .cursor-ring.hovering {
    width: 48px;
    height: 48px;
    margin-left: -24px;
    margin-top: -24px;
    background: rgba(244, 114, 182, 0.15);
    border-color: rgba(244, 114, 182, 0.8);
    box-shadow: 0 0 15px rgba(192, 132, 252, 0.4);
    animation: none; 
  }

  /* === 文字模式 (Text Mode) === */
  /* 回歸原本設定：變小，稍微實心，作為文字背景光 */
  .cursor-ring.text-mode {
    width: 24px;
    height: 24px;
    margin-left: -12px;
    margin-top: -12px;
    border-color: transparent;
    background: rgba(244, 114, 182, 0.25);
    box-shadow: 0 0 15px rgba(244, 114, 182, 0.3);
    animation: none;
  }

  /* 在 Hover 或 Text 模式隱藏中心點 */
  .cursor-dot.hovering,
  .cursor-dot.text-mode {
    opacity: 0 !important;
  }
  
  .cursor-ring.clicking {
    width: 20px;
    height: 20px;
    margin-left: -10px;
    margin-top: -10px;
    background: rgba(255, 255, 255, 0.9);
    border-color: transparent;
  }

  /* 當按住滑鼠拖曳選字時，光圈優雅地縮小並消失 */
  .cursor-ring.selecting {
    opacity: 0 !important;
    transform: scale(0.5);
    background: rgba(244, 114, 182, 0.1);
  }
</style>