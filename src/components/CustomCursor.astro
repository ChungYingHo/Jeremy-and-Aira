---
// src/components/CustomCursor.astro
---

<div id="cursor-dot" class="cursor-dot"></div>
<div id="cursor-ring" class="cursor-ring"></div>

<script>
const initCursor = () => {
  // 1. 裝置檢測：觸控裝置 (手機/平板) 不啟用自定義游標
  if (window.matchMedia('(pointer: coarse)').matches) return

  const dot = document.getElementById('cursor-dot')
  const ring = document.getElementById('cursor-ring')

  if (!dot || !ring) return

  let mouseX = -100
  let mouseY = -100
  let ringX = -100
  let ringY = -100

  // 2. 初始顯示
  document.addEventListener('mousemove', (e) => {
    mouseX = e.clientX
    mouseY = e.clientY
    
    // 讓 dot 瞬間移動 (無延遲)
    dot.style.transform = `translate(${mouseX}px, ${mouseY}px)`
  })

  // 3. 點擊效果
  document.addEventListener('mousedown', () => {
    ring.classList.add('clicking')
  })

  document.addEventListener('mouseup', () => {
    ring.classList.remove('clicking')
  })

  // 4. Hover 偵測
  const addHoverListeners = () => {
    const interactiveElements = document.querySelectorAll('a, button, [role="button"], input, select, textarea, .hover-trigger')
    
    interactiveElements.forEach((el) => {
      el.addEventListener('mouseenter', () => {
        ring.classList.add('hovering')
        dot.classList.add('hovering')
      })
      el.addEventListener('mouseleave', () => {
        ring.classList.remove('hovering')
        dot.classList.remove('hovering')
      })
    })
  }

  addHoverListeners()
  
  const observer = new MutationObserver(addHoverListeners)
  observer.observe(document.body, { childList: true, subtree: true })

  // 5. 動畫迴圈
  const render = () => {
    ringX += (mouseX - ringX) * 0.15
    ringY += (mouseY - ringY) * 0.15

    ring.style.transform = `translate(${ringX}px, ${ringY}px)`

    requestAnimationFrame(render)
  }

  requestAnimationFrame(render)
}

document.addEventListener('astro:page-load', initCursor)
document.addEventListener('DOMContentLoaded', initCursor)
</script>

<style>
  /* 全局隱藏預設游標 */
  @media (pointer: fine) {
    :global(body), :global(a), :global(button) {
      cursor: none;
    }
  }

  /* --- 實心小點 (Dot) --- */
  .cursor-dot {
    position: fixed;
    top: 0;
    left: 0;
    width: 8px;
    height: 8px;
    background-color: white;
    border-radius: 50%;
    pointer-events: none;
    z-index: 10001; /* [修改] 層級極高，蓋過 Menu */
    margin-left: -4px; 
    margin-top: -4px;
    mix-blend-mode: exclusion;
    transition: width 0.3s, height 0.3s, opacity 0.3s;
  }

  .cursor-dot.hovering {
    opacity: 0;
  }

  /* --- 柔光光暈 (Ring) --- */
  .cursor-ring {
    position: fixed;
    top: 0;
    left: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 10000; /* [修改] 層級極高，蓋過 Menu */
    margin-left: -16px;
    margin-top: -16px;
    
    border: 1px solid rgba(244, 114, 182, 0.4);
    background: radial-gradient(circle, rgba(244, 114, 182, 0.1) 0%, transparent 70%);
    box-shadow: 0 0 10px rgba(244, 114, 182, 0.2);
    
    mix-blend-mode: screen;
    transition: width 0.3s cubic-bezier(0.25, 1, 0.5, 1), 
                height 0.3s cubic-bezier(0.25, 1, 0.5, 1),
                background-color 0.3s,
                border-color 0.3s;
  }

  /* Hover 狀態：光暈放大 */
  .cursor-ring.hovering {
    /* [修改] 縮小尺寸至 48px，更精緻 */
    width: 48px;
    height: 48px;
    margin-left: -24px;
    margin-top: -24px;
    
    background: rgba(244, 114, 182, 0.15);
    border-color: rgba(244, 114, 182, 0.8);
    box-shadow: 0 0 15px rgba(192, 132, 252, 0.4);
  }

  /* Click 狀態 */
  .cursor-ring.clicking {
    width: 24px;
    height: 24px;
    margin-left: -12px;
    margin-top: -12px;
    background: rgba(255, 255, 255, 0.8);
    border-color: transparent;
  }
</style>